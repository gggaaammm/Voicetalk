<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Voice Control</title>
    <script src="{{ url_for('static', filename='js/jquery.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/csmapi.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/dan.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/dai.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/ida.js') }}" type="text/javascript"></script>
    <!--cript src="js/jquery.js" type="text/javascript"></script>
    <script src="js/csmapi.js"></script>
    <script src="js/dan.js"></script>
    <script src="js/dai.js"></script>
    <script src="js/ida.js"></script-->
  </head>
  <body>
    <script type="text/javascript">
      var infoBox; // 訊息 label
      var textBox; // 最終的辨識訊息 text input
      var tempBox; // 中間的辨識訊息 text input
      var startStopButton; // 「辨識/停止」按鈕
      var languageselect; // 語言選單
      var final_transcript = ''; // 最終的辨識訊息的變數
      var recognizing = false; // 是否辨識中
    
        
      function selectLanguage(event){
          infoBox = document.getElementById("infoBox"); // 取得訊息控制項 infoBox
          textBox = document.getElementById("textBox"); // 取得最終的辨識訊息控制項 textBox
          selectlangBox = document.getElementById("selectlangBox");
          langvalue = selectlangBox.options[selectlangBox.selectedIndex].value;
          $("#textres").val("");
          $("#textBox").val("");
          final_transcript="";
          recoglabel = ["Recognition Result: ","辨識結果: "]
          responselabel = ["System Response: ","系統回覆: "]
          
          
          recognition.stop();
          if(langvalue == "en-US"){
              recognition.lang = "en-US";
              console.log("change to eng");
              $("#recoglabel").html(recoglabel[0])
              $("#responselabel").html(responselabel[0])
              infoBox.innerText = "Tap to talk"
              
          }else{
              recognition.lang = "cmn-Hant-TW";
              console.log("change to zh");
              $("#recoglabel").html(recoglabel[1])
              $("#responselabel").html(responselabel[1])
              infoBox.innerText = "點選開始"
          }
          
         
            
        }
        
      function startButton(event) {
        infoBox = document.getElementById("infoBox"); // 取得訊息控制項 infoBox
        textBox = document.getElementById("textBox"); // 取得最終的辨識訊息控制項 textBox
        startStopButton = document.getElementById("startStopButton"); // 取得「辨識/停止」這個按鈕控制項
        selectlangBox = document.getElementById("selectlangBox");
        langvalue = selectlangBox.options[selectlangBox.selectedIndex].value;
        if (recognizing) { // 如果正在辨識，則停止。
          recognition.stop();
        } else { // 否則就開始辨識
          textBox.value = ''; // 清除最終的辨識訊息
          final_transcript = ''; // 最終的辨識訊息變數
            recognition.lang = langvalue
//           recognition.lang = "cmn-Hant-TW"; // 設定辨識語言 "cmn-Hant-TW", "en-US"
          recognition.start(); // 開始辨識
        }
      }

      if (!('webkitSpeechRecognition' in window)) {  // 如果找不到 window.webkitSpeechRecognition 這個屬性
        // 就是不支援語音辨識，要求使用者更新瀏覽器。 
        infoBox.innerText = "本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)";
      } else {
        var recognition = new webkitSpeechRecognition(); // 建立語音辨識物件 webkitSpeechRecognition
        recognition.continuous = true; // 設定連續辨識模式
        recognition.interimResults = true; // 設定輸出中先結果。
        /// 新的規則
          var grammar = '#JSGF V1.0; grammar brands; public <brand> = Tatung | Chimei | CHT ;'
          var speechRecognitionList = new webkitSpeechGrammarList();
            speechRecognitionList.addFromString(grammar, 1);
             recognition.grammars = speechRecognitionList;
          

        recognition.onstart = function() { // 開始辨識
          recognizing = true; // 設定為辨識中
          // startStopButton.value = "按此停止"; // 辨識中...按鈕改為「按此停止」。  
          if(langvalue == "en-US"){
              infoBox.innerText = "Tap to stop";  // 顯示訊息為「辨識中」...
          }else{
              infoBox.innerText = "點選停止";  // 顯示訊息為「辨識中」...
          }
          startStopButton.src="{{ url_for('static', filename='images/start.gif') }}";
          // document.getElementById("indication").innerHTML = "Tap to pause";
        };

        recognition.onend = function() { // 辨識完成
          recognizing = false; // 設定為「非辨識中」
          // startStopButton.value = "開始辨識";  // 辨識完成...按鈕改為「開始辨識」。
           if(langvalue == "en-US"){
               infoBox.innerText = "Tap to talk";  // 顯示訊息為
           }else{
               infoBox.innerText = "點選開始"; // 不顯示訊息
           }
          // document.getElementById("indication").innerHTML = "Tap to talk";
          startStopButton.src="{{ url_for('static', filename='images/stop.jpg') }}";

        };

        recognition.onresult = function(event) { // 辨識有任何結果時
          for (var i = event.resultIndex; i < event.results.length; ++i) { // 對於每一個辨識結果
            if (event.results[i].isFinal) { // 如果是最終結果
                final_transcript = event.results[i][0].transcript; // 將其加入最終結果中
                console.log("i:" + i + event.results[i][0].transcript);
            } else { // 否則
              interim_transcript += event.results[i][0].transcript; // 將其加入中間結果中
            }
          }
          if (final_transcript.trim().length > 0) // 如果有最終辨識文字
              textBox.value = final_transcript; // 顯示最終辨識文字
            // go to backend
            
            
//             const request = new XMLHttpRequest()
//             request.open('POST', '/')
//             request.setRequestHeader('Content-Type','text/plain; charset=utf-8')
//             request.send(final_transcript)
            
            var val = 1;
            var entry1 = 3;
            var language = langvalue;

            $.getJSON({
                url: "/ProcessSentence",
                data: { entry2_id: val, entry1_id: entry1 , lang_id : language, voice : final_transcript},
                success: function(data){
                    console.log("AA", data)
                    if(data.response == "很抱歉，聽不懂請重講"  || data.response == "I\'m sorry, try again."){
                        renderhtml = data.response
                    }
                    else if(langvalue == "en-US"){
                        renderhtml = data.response+data.tokenlist[0]+data.tokenlist[1]+" "+data.tokenlist[2]+" "+data.tokenlist[3]+data.valid
                    }
                    else{
                        renderhtml = data.response+data.tokenlist[0]+data.tokenlist[1]+data.tokenlist[2]+data.tokenlist[3]+data.valid
                    }
                    console.log(renderhtml)
                    $("#textres").val(renderhtml);
                },
                error: function(){
                    //alert("fail")
                }
            });
             
            //
            
              if(final_transcript.match("我愛你")!=null){
                console.log("OPEN");
                dan.push('Dummy_Sensor',[1]);
              }else if(final_transcript.match("不愛你")!=null){
                console.log("CLOSE");
                dan.push('Dummy_Sensor',[0]);
              }
        };
      }
        
        
        
    </script>

    <div class="container text-center">
      <div class="form-group">
        <br>
        <h1 class="h3 mb-3 font-weight-normal">VoiceTalk Voice Control</h1>
        <div class="col-sm">
          <label id = "recoglabel" for="textBox">辨識結果:</label>
          <input id="textBox" class="form-control" type="text" size="60" value=""/>
            <br>
            <br>
          <form method="post">
            <input type="text" name="user">
            <input type="submit" name="send" value="文字送出">
          </form>
        </div>
        <div class="col-sm">
            <!--span>{{response}}
                  {{returnlist.0}}
                  {{returnlist.1}}
                  {{returnlist.2}}
                  {{returnlist.3}}</span-->
            <label id="responselabel" for="textBox">系統回覆:</label>
            <div id = "resultarea">
                  <input id="textres" class="form-control" size="60" readonly />
                  <span id="response"></span>
                  <span id="A"></span>
                  <span id="D"></span>
                  <span id="F"></span>
                  <span id="V"></span>
            </div>
        </div>    
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <div class="col-sm">
        <!--input id="startStopButton" class="btn btn-lg btn-primary btn-block" style="background-image:url('https://www.ashnik.com/wp-content/uploads/2018/07/voice.gif');margin: auto; width:80px;height:80px;border-radius:999em;" type="button" onclick="startButton(event)"/> -->
          <img id="startStopButton" style="width:110px; height:110px;" onclick="startButton(event)" src="{{ url_for('static', filename='images/start.gif') }}"/>
            
          <br>
          <p id="infoBox">Tap to talk</p>
          <!-- <p id="indication">Tap to talk</p> -->
        </div>
          <form method="post" >
              <select id = "selectlangBox" name="lang" onchange="selectLanguage(event)" >
                    <option value="cmn-Hant-TW">中文</option>
                    <option value="en-US">English</option>
                </select>
          </form>
      </div>
    </div>
    

    <script type="text/javascript">
        window.onload = startButton(event);
        window.onload = selectLanguage(event);
    </script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
